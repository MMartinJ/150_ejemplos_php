<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Grabar video y descargar enlace</title>
  <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
  <style>
    video {
      max-width: 100%;
      background: #000;
    }
    button {
      margin: 5px;
      padding: 10px;
    }
  </style>
</head>
<body>

  <!-- Vista previa del vídeo -->
  <video id="videoElement" autoplay playsinline></video>

  <!-- Botones -->
  <button id="startButton">Iniciar Grabación</button>
  <button id="stopButton" disabled>Detener Grabación</button>

  <!-- Enlace de descarga -->
  <div id="downloadSection"></div>

  <script>
    const videoElement = document.getElementById('videoElement');
    const startButton = document.getElementById('startButton');
    const stopButton = document.getElementById('stopButton');
    const downloadSection = document.getElementById('downloadSection');

    let recordRTC;
    let mediaStream;

    // 1️⃣ Al cargar la página, pedimos permiso y mostramos la cámara
    window.addEventListener('load', async () => {
      try {
        // Pedimos acceso a cámara y micrófono
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }, // cámara trasera si está disponible
          audio: true
        });

        // Mostramos la vista previa
        videoElement.srcObject = mediaStream;

      } catch (error) {
        console.error('Error al acceder a la cámara/micrófono:', error);
      }
    });

    // 2️⃣ Al pulsar "Iniciar Grabación"
    startButton.addEventListener('click', () => {
      if (!mediaStream) {
        console.error('No hay acceso a la cámara/micrófono.');
        return;
      }

      // Creamos el grabador usando el stream ya obtenido
      recordRTC = RecordRTC(mediaStream, { type: 'video' });
      recordRTC.startRecording();

      startButton.disabled = true;
      stopButton.disabled = false;
    });

    // 3️⃣ Al pulsar "Detener Grabación"
    stopButton.addEventListener('click', () => {
      recordRTC.stopRecording(() => {
        const blob = recordRTC.getBlob();
        const videoURL = URL.createObjectURL(blob);

        // Creamos enlace de descarga
        const downloadLink = document.createElement('a');
        downloadLink.href = videoURL;
        downloadLink.download = 'grabacion.webm';
        downloadLink.textContent = 'Descargar video';

        downloadSection.innerHTML = '';
        downloadSection.appendChild(downloadLink);

        recordRTC.reset();

        startButton.disabled = false;
        stopButton.disabled = true;
      });
    });
  </script>

</body>
</html>
